# ğŸ¯ BitVMX í•¨ìˆ˜ ë¹Œë“œ ì‹œìŠ¤í…œ

# ì»´íŒŒì¼ëŸ¬ ì„¤ì •
RISCV_PREFIX = riscv64-elf-
CC = $(RISCV_PREFIX)gcc
AS = $(RISCV_PREFIX)as
LD = $(RISCV_PREFIX)ld
OBJCOPY = $(RISCV_PREFIX)objcopy
SIZE = $(RISCV_PREFIX)size
READELF = $(RISCV_PREFIX)readelf

# ì»´íŒŒì¼ í”Œë˜ê·¸
ARCH_FLAGS = -march=rv32im -mabi=ilp32
CFLAGS = $(ARCH_FLAGS) -g
LDFLAGS = -m elf32lriscv -T linker.ld --nmagic --gc-sections

# íŒŒì¼ ì •ì˜
TARGET_NAME = my_function
BUILD_DIR = build
SRC_DIR = src

# ìµœì¢… íŒŒì¼ë“¤
ELF_FILE = $(BUILD_DIR)/$(TARGET_NAME).elf
BIN_FILE = $(BUILD_DIR)/$(TARGET_NAME).bin
HEX_FILE = $(BUILD_DIR)/$(TARGET_NAME).hex
MAP_FILE = $(BUILD_DIR)/$(TARGET_NAME).map

# ê¸°ë³¸ íƒ€ê²Ÿ
all: $(ELF_FILE) $(BIN_FILE) $(HEX_FILE) size info

# ë””ë ‰í† ë¦¬ ìƒì„±
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# Rust ì»´íŒŒì¼
rust-compile:
	@echo "ğŸ¦€ Rust ì½”ë“œ ì»´íŒŒì¼ ì¤‘..."
	rustup override set nightly
	cargo +nightly rustc --release --bin $(TARGET_NAME) \
		--target riscv32im-unknown-none-elf \
		-Z build-std=core,compiler_builtins \
		-Z build-std-features=panic_immediate_abort \
		-- --emit=obj

# ì–´ì…ˆë¸”ë¦¬ ì»´íŒŒì¼
$(BUILD_DIR)/start.o: $(SRC_DIR)/start.S | $(BUILD_DIR)
	@echo "âš™ï¸ ì–´ì…ˆë¸”ë¦¬ ì‹œì‘ ì½”ë“œ ì»´íŒŒì¼ ì¤‘..."
	$(AS) $(ARCH_FLAGS) -g -o $@ $<

# ELF ë§í‚¹
$(ELF_FILE): rust-compile $(BUILD_DIR)/start.o | $(BUILD_DIR)
	@echo "ğŸ”— ELF íŒŒì¼ ìƒì„± ì¤‘..."
	$(LD) $(LDFLAGS) -Map=$(MAP_FILE) --print-memory-usage \
		-o $@ \
		$(BUILD_DIR)/start.o \
		target/riscv32im-unknown-none-elf/release/deps/$(TARGET_NAME)-*.o
	@echo "âœ… ELF íŒŒì¼ ìƒì„± ì™„ë£Œ: $@"

# ë°”ì´ë„ˆë¦¬ ìƒì„±
$(BIN_FILE): $(ELF_FILE)
	@echo "ğŸ“¦ ë°”ì´ë„ˆë¦¬ íŒŒì¼ ìƒì„± ì¤‘..."
	$(OBJCOPY) -O binary $< $@
	@echo "âœ… ë°”ì´ë„ˆë¦¬ íŒŒì¼ ìƒì„± ì™„ë£Œ: $@"

# HEX íŒŒì¼ ìƒì„±
$(HEX_FILE): $(ELF_FILE)
	@echo "ğŸ“‹ HEX íŒŒì¼ ìƒì„± ì¤‘..."
	$(OBJCOPY) -O ihex $< $@
	@echo "âœ… HEX íŒŒì¼ ìƒì„± ì™„ë£Œ: $@"

# í¬ê¸° ì •ë³´
size: $(ELF_FILE)
	@echo ""
	@echo "ğŸ“Š íŒŒì¼ í¬ê¸° ì •ë³´:"
	$(SIZE) $<

# ìƒì„¸ ì •ë³´
info: $(ELF_FILE)
	@echo ""
	@echo "ğŸ” ì„¹ì…˜ ì •ë³´:"
	$(READELF) -S $< | head -20
	@echo ""
	@echo "ğŸ“„ ìƒì„±ëœ íŒŒì¼ë“¤:"
	ls -la $(BUILD_DIR)/

# ì •ë¦¬
clean:
	@echo "ğŸ§¹ ì •ë¦¬ ì¤‘..."
	rm -rf $(BUILD_DIR)
	rm -rf target
	cargo clean
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ"

.PHONY: all rust-compile size info clean