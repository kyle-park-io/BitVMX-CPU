# BitVM(X) ë‹¨ë°©í–¥ ì˜µì…˜ Makefile
# RISC-V 32ë¹„íŠ¸ í¬ë¡œìŠ¤ ì»´íŒŒì¼ ì„¤ì •

# ë„êµ¬ì²´ì¸ ì„¤ì •
PREFIX = riscv64-elf-
CC = $(PREFIX)gcc
AS = $(PREFIX)as
LD = $(PREFIX)ld
OBJCOPY = $(PREFIX)objcopy
OBJDUMP = $(PREFIX)objdump
READELF = $(PREFIX)readelf
SIZE = $(PREFIX)size

# í”„ë¡œì íŠ¸ ì„¤ì •
PROJECT_NAME = one_way_option
BUILD_DIR = build
SRC_DIR = src

# RISC-V 32ë¹„íŠ¸ ì»´íŒŒì¼ í”Œë˜ê·¸
CFLAGS = -march=rv32im \
         -mabi=ilp32 \
         -O2 \
         -nostdlib \
         -nostartfiles \
         -fno-common \
         -ffunction-sections \
         -fdata-sections \
         -Wall \
         -Wextra \
         -g

# ì–´ì…ˆë¸”ë¦¬ í”Œë˜ê·¸
ASFLAGS = -march=rv32im \
          -mabi=ilp32 \
          -g

# ë§ì»¤ í”Œë˜ê·¸
LDFLAGS = -m elf32lriscv \
          -T linker.ld \
          --nmagic \
          --gc-sections \
          -Map=$(BUILD_DIR)/$(PROJECT_NAME).map \
          --print-memory-usage

# íŒŒì¼ ì •ì˜
ASM_SRC = $(SRC_DIR)/start.S
RUST_OBJ = $(shell find target/riscv32i-unknown-none-elf/release/deps -name "$(PROJECT_NAME)-*.o" -type f | head -1)
ELF_FILE = $(BUILD_DIR)/$(PROJECT_NAME).elf
BIN_FILE = $(BUILD_DIR)/$(PROJECT_NAME).bin
HEX_FILE = $(BUILD_DIR)/$(PROJECT_NAME).hex
ASM_OBJ = $(BUILD_DIR)/start.o

# ê¸°ë³¸ íƒ€ê²Ÿ
all: $(ELF_FILE) $(BIN_FILE) $(HEX_FILE) info

# ë¹Œë“œ ë””ë ‰í† ë¦¬ ìƒì„±
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# Rust ì½”ë“œ ì»´íŒŒì¼ (ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë§Œ ìƒì„±)
rust-build:
	@echo "ğŸ¦€ Rust ì½”ë“œ ì»´íŒŒì¼ ì¤‘..."
	rustup override set nightly
	cargo +nightly rustc --release --bin $(PROJECT_NAME) \
		-Z build-std=core,compiler_builtins \
		-Z build-std-features=panic_immediate_abort \
		-- --emit=obj

# ì–´ì…ˆë¸”ë¦¬ ì‹œì‘ ì½”ë“œ ì»´íŒŒì¼
$(ASM_OBJ): $(ASM_SRC) | $(BUILD_DIR)
	@echo "âš™ï¸ ì–´ì…ˆë¸”ë¦¬ ì‹œì‘ ì½”ë“œ ì»´íŒŒì¼ ì¤‘..."
	$(AS) $(ASFLAGS) -o $@ $<

# ELF íŒŒì¼ ìƒì„± (Rust + ì–´ì…ˆë¸”ë¦¬)
$(ELF_FILE): rust-build $(ASM_OBJ) linker.ld | $(BUILD_DIR)
	@echo "ğŸ”— ELF íŒŒì¼ ìƒì„± ì¤‘..."
	$(LD) $(LDFLAGS) \
		-o $@ \
		$(ASM_OBJ) \
		$(RUST_OBJ)
	@echo "âœ… ELF íŒŒì¼ ìƒì„± ì™„ë£Œ: $@"

# ë°”ì´ë„ˆë¦¬ íŒŒì¼ ìƒì„±
$(BIN_FILE): $(ELF_FILE)
	@echo "ğŸ“¦ ë°”ì´ë„ˆë¦¬ íŒŒì¼ ìƒì„± ì¤‘..."
	$(OBJCOPY) -O binary $< $@
	@echo "âœ… ë°”ì´ë„ˆë¦¬ íŒŒì¼ ìƒì„± ì™„ë£Œ: $@"

# Intel HEX íŒŒì¼ ìƒì„±
$(HEX_FILE): $(ELF_FILE)
	@echo "ğŸ“‹ HEX íŒŒì¼ ìƒì„± ì¤‘..."
	$(OBJCOPY) -O ihex $< $@
	@echo "âœ… HEX íŒŒì¼ ìƒì„± ì™„ë£Œ: $@"

# íŒŒì¼ ì •ë³´ ì¶œë ¥
info: $(ELF_FILE)
	@echo ""
	@echo "ğŸ“Š íŒŒì¼ í¬ê¸° ì •ë³´:"
	$(SIZE) $(ELF_FILE)
	@echo ""
	@echo "ğŸ” ì„¹ì…˜ ì •ë³´:"
	$(READELF) -S $(ELF_FILE) | head -20
	@echo ""
	@echo "ğŸ“„ ìƒì„±ëœ íŒŒì¼ë“¤:"
	@ls -la $(BUILD_DIR)/

# ë””ìŠ¤ì–´ì…ˆë¸”ë¦¬ ìƒì„±
disasm: $(ELF_FILE)
	@echo "ğŸ” ë””ìŠ¤ì–´ì…ˆë¸”ë¦¬ ìƒì„± ì¤‘..."
	$(OBJDUMP) -d $(ELF_FILE) > $(BUILD_DIR)/$(PROJECT_NAME).s
	@echo "âœ… ë””ìŠ¤ì–´ì…ˆë¸”ë¦¬ ìƒì„± ì™„ë£Œ: $(BUILD_DIR)/$(PROJECT_NAME).s"

# BitVM(X) ì—ë®¬ë ˆì´í„°ì—ì„œ ì‹¤í–‰
run: $(ELF_FILE)
	@echo "ğŸš€ BitVM(X) ì—ë®¬ë ˆì´í„°ì—ì„œ ì‹¤í–‰ ì¤‘..."
	cd ../emulator && cargo run execute --elf-path ../one_way_option_complete/$(ELF_FILE)

# ì‹¤í–‰ íŠ¸ë ˆì´ìŠ¤ ìƒì„±
trace: $(ELF_FILE)
	@echo "ğŸ“ ì‹¤í–‰ íŠ¸ë ˆì´ìŠ¤ ìƒì„± ì¤‘..."
	cd ../emulator && cargo run execute --elf-path ../one_way_option_complete/$(ELF_FILE) --trace > ../one_way_option_complete/$(BUILD_DIR)/trace.log
	@echo "âœ… ì‹¤í–‰ íŠ¸ë ˆì´ìŠ¤ ìƒì„± ì™„ë£Œ: $(BUILD_DIR)/trace.log"

# í•´ì‹œ ìƒì„±
hash: $(ELF_FILE)
	@echo "ğŸ” BitVM(X) í•´ì‹œ ìƒì„± ì¤‘..."
	cd ../emulator && cargo run execute --elf-path ../one_way_option_complete/$(ELF_FILE) --output-hash > ../one_way_option_complete/$(BUILD_DIR)/hashes.json
	@echo "âœ… í•´ì‹œ ìƒì„± ì™„ë£Œ: $(BUILD_DIR)/hashes.json"

# ì „ì²´ BitVM(X) í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
bitvmx: $(ELF_FILE)
	@echo "ğŸ¯ ì™„ì „í•œ BitVM(X) í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì¤‘..."
	@$(MAKE) run
	@$(MAKE) trace  
	@$(MAKE) hash
	@echo "ğŸ‰ BitVM(X) í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!"

# ì •ë¦¬
clean:
	@echo "ğŸ§¹ ì •ë¦¬ ì¤‘..."
	rm -rf $(BUILD_DIR)
	rm -rf target
	cargo clean
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ"

# ê¹Šì€ ì •ë¦¬
clean-all: clean
	@echo "ğŸ§¹ ì „ì²´ ì •ë¦¬ ì¤‘..."
	rustup override unset
	@echo "âœ… ì „ì²´ ì •ë¦¬ ì™„ë£Œ"

# ê°œë°œ í™˜ê²½ ì„¤ì •
setup:
	@echo "ğŸ”§ ê°œë°œ í™˜ê²½ ì„¤ì • ì¤‘..."
	rustup toolchain install nightly
	rustup override set nightly
	rustup target add riscv32i-unknown-none-elf --toolchain nightly
	@echo "âœ… ê°œë°œ í™˜ê²½ ì„¤ì • ì™„ë£Œ"

# í—¬í”„ ë©”ì‹œì§€
help:
	@echo "ğŸ“š BitVM(X) ë‹¨ë°©í–¥ ì˜µì…˜ ë¹Œë“œ ì‹œìŠ¤í…œ"
	@echo ""
	@echo "ì£¼ìš” íƒ€ê²Ÿ:"
	@echo "  all      - ì „ì²´ ë¹Œë“œ (ELF, BIN, HEX)"
	@echo "  run      - BitVM(X) ì—ë®¬ë ˆì´í„°ì—ì„œ ì‹¤í–‰"
	@echo "  trace    - ì‹¤í–‰ íŠ¸ë ˆì´ìŠ¤ ìƒì„±"
	@echo "  hash     - BitVM(X) í•´ì‹œ ìƒì„±"
	@echo "  bitvmx   - ì™„ì „í•œ BitVM(X) í”„ë¡œì„¸ìŠ¤"
	@echo "  disasm   - ë””ìŠ¤ì–´ì…ˆë¸”ë¦¬ ìƒì„±"
	@echo "  info     - íŒŒì¼ ì •ë³´ ì¶œë ¥"
	@echo "  clean    - ì •ë¦¬"
	@echo "  setup    - ê°œë°œ í™˜ê²½ ì„¤ì •"
	@echo "  help     - ì´ ë©”ì‹œì§€"

# Phony íƒ€ê²Ÿ
.PHONY: all rust-build run trace hash bitvmx disasm info clean clean-all setup help

# ê¸°ë³¸ íƒ€ê²Ÿ
.DEFAULT_GOAL := all 